<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>在Go语言中如何更详细地处理与包装错误 | mutezebra</title>
<meta name="keywords" content="Go, error, log">
<meta name="description" content="在Go语言中如何更详细地处理与包装错误">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/how-to-handler-and-wrap-error/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css" integrity="sha256-1vzSCk&#43;4bvpN&#43;sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/how-to-handler-and-wrap-error/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="mutezebra (Alt + H)">mutezebra</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/posts/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      在Go语言中如何更详细地处理与包装错误
    </h1>
    <div class="post-description">
      在Go语言中如何更详细地处理与包装错误
    </div>
    <div class="post-meta"><span title='2024-11-25 00:00:00 +0000 UTC'>November 25, 2024</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1go%e8%af%ad%e8%a8%80%e4%b8%ad%e7%9a%84%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e5%9f%ba%e7%a1%80" aria-label="1.Go语言中的错误处理基础">1.Go语言中的错误处理基础</a></li>
                <li>
                    <a href="#2go113%e7%9a%84%e9%94%99%e8%af%af%e5%8c%85%e8%a3%85%e6%9c%ba%e5%88%b6" aria-label="2.Go1.13的错误包装机制">2.Go1.13的错误包装机制</a></li>
                <li>
                    <a href="#3%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%99%e8%af%af%e7%b1%bb%e5%9e%8b" aria-label="3.自定义错误类型">3.自定义错误类型</a></li>
                <li>
                    <a href="#4%e4%bd%bf%e7%94%a8%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%99%e8%af%af%e7%b1%bb%e5%9e%8b%e7%9a%84%e7%a4%ba%e4%be%8b" aria-label="4.使用自定义错误类型的示例">4.使用自定义错误类型的示例</a></li>
                <li>
                    <a href="#5%e8%b0%83%e7%94%a8%e6%a0%88%e4%bf%a1%e6%81%af%e7%9a%84%e8%8e%b7%e5%8f%96%e4%b8%8e%e5%b0%81%e8%a3%85" aria-label="5.调用栈信息的获取与封装">5.调用栈信息的获取与封装</a></li>
                <li>
                    <a href="#6%e8%b0%83%e7%94%a8%e6%a0%88%e6%a0%bc%e5%bc%8f%e5%8c%96%e4%b8%8e%e8%be%93%e5%87%ba" aria-label="6.调用栈格式化与输出">6.调用栈格式化与输出</a></li>
                <li>
                    <a href="#7%e5%b0%86%e8%b0%83%e7%94%a8%e6%a0%88%e9%9b%86%e6%88%90%e5%88%b0%e8%87%aa%e5%ae%9a%e4%b9%89%e9%94%99%e8%af%af%e4%b8%ad" aria-label="7.将调用栈集成到自定义错误中">7.将调用栈集成到自定义错误中</a></li>
                <li>
                    <a href="#8%e7%bb%93%e5%b0%be" aria-label="8.结尾">8.结尾</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="1go语言中的错误处理基础">1.Go语言中的错误处理基础<a hidden class="anchor" aria-hidden="true" href="#1go语言中的错误处理基础">#</a></h2>
<p>在go语言中，我们使用<code>error</code>接口来处理错误，error接口的定义十分简单，只需要包含有 <strong>Error() string</strong> 方法即可。但如何从一层一层的程序中详细完整的传递，记录错误，以及如何去方便快捷的找到错误根源，显然是一个难点。本文就针对这个难点来发表一些浅薄的个人见解。（注：本文更注重于表述个人见解，如若对您有帮助，更建议结合个人项目搭建错误处理与日志体系）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#66d9ef">error</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我认为处理错误的最重要的两点在于错误链与调用栈，当一个<code>error</code> 发生时，我们需要在调用处知道完整的错误链，以及在错误发生处知道完整的调用栈，有了这两点我们就既可以得知环环相扣的错误信息，又能根据调用栈直截了当的知晓调用流程和错误源头。本篇文章不会对两者的结合展开叙述，只是单独的解释和演示相关机制。</p>
<h2 id="2go113的错误包装机制">2.Go1.13的错误包装机制<a hidden class="anchor" aria-hidden="true" href="#2go113的错误包装机制">#</a></h2>
<p>从Go 1.13开始，标准库提供了错误包装功能。你可以使用<code>fmt.Errorf</code>和<code>%w</code>格式化动词来包装错误，这样可以保留原始错误的上下文信息，同时添加更多描述。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">do</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to do..., %w&#34;</span>,<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里给出应用错误链的一个简单demo。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">do</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Unwrap</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;err: %v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;origin: %v\n&#34;</span>, <span style="color:#a6e22e">e</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">do</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">learn</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;do something failed, %w&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">learn</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;can`t learn&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最终的输出如下：</p>
<blockquote>
<p>err: do something failed, can`t learn</p>
<p>origin: can`t learn</p>
</blockquote>
<p>看到这里相信你已经有了一些奇思妙想了，利用错误链的机制不仅可以传递错误信息，还因为<code>Unwrap</code>的存在而有了更多可能性，现在我来介绍如何自定义错误类型并传递额外信息。</p>
<h2 id="3自定义错误类型">3.自定义错误类型<a hidden class="anchor" aria-hidden="true" href="#3自定义错误类型">#</a></h2>
<p>首先，我们定义一个自己的结构体,和一个满足自己结构体方法的接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Merror</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Extra</span>() <span style="color:#a6e22e">any</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">merror</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg</span>   <span style="color:#66d9ef">string</span> <span style="color:#75715e">// 存储错误信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">extra</span> <span style="color:#66d9ef">int64</span> <span style="color:#75715e">// 存储额外的信息(any type)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// New 创建一个新的结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">extra</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int64</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">merror</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span>:   <span style="color:#a6e22e">msg</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">extra</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">extra</span> = <span style="color:#a6e22e">extra</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">merror</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">msg</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">merror</span>) <span style="color:#a6e22e">Extra</span>() <span style="color:#a6e22e">any</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">extra</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Format 用于进行格式化的输出，在遇到占位符时转换为我们想要的内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">merror</span>) <span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">state</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">verb</span> <span style="color:#66d9ef">rune</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">verb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;s&#39;</span>, <span style="color:#e6db74">&#39;v&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;msg: %s,extra: %d&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">extra</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们自定义的<code>merror</code> 实现了<strong>Error() string</strong> 与 <strong>Formatter(state,rune)</strong> 接口。对于前者，这意味着<code>merror</code> 可以被当成<code>error</code> 传递。对于后者，这让我们可以自己实现我们所想要的的输出格式。</p>
<h2 id="4使用自定义错误类型的示例">4.使用自定义错误类型的示例<a hidden class="anchor" aria-hidden="true" href="#4使用自定义错误类型的示例">#</a></h2>
<p>现在来进行一个demo对上述代码进行演示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">merror</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;a error&#34;</span>, <span style="color:#ae81ff">1024</span>) <span style="color:#75715e">// 获取一个新的 error,并传递一个 extra为1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Error</span>()) <span style="color:#75715e">// 输出error的内容,这里应该是a error
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ex</span> <span style="color:#a6e22e">merror</span>.<span style="color:#a6e22e">Merror</span> <span style="color:#75715e">// 声明一个自定义接口的变量，用于判断error是否是merror
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">As</span>(<span style="color:#a6e22e">e</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ex</span>) { <span style="color:#75715e">// 如果是merror的话，就输出Extra方法返回的内容，并且格式化输出 merror
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d\n&#34;</span>, <span style="color:#a6e22e">ex</span>.<span style="color:#a6e22e">Extra</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%v\n&#34;</span>, <span style="color:#a6e22e">ex</span>) <span style="color:#75715e">// 这里的%v占位符就对应着上述Format方法中的case &#39;v&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最终输出</p>
<blockquote>
<p>a error<br>
1024<br>
msg: a error,extra: 1024</p>
</blockquote>
<p>到这里让我们简单梳理一下前面都讲了些什么：</p>
<ol>
<li>实现 <strong>Error() string</strong>方法的结构体都是<code>error</code></li>
<li>利用<strong>fmt.Errorf(&quot;%w&quot;)</strong> 可以对错误进行封装形成调用链</li>
<li>自定义一个实现了<code>error</code>接口的结构体，并包含有额外字段。实现<code>fmt.Formatter</code>接口</li>
<li>使用<strong>errors.As()</strong> 获取自定义error的信息</li>
</ol>
<p>结合所有的这些，相信你对接下来要发生什么已经有所猜测了！没错，我们接下来要在<code>merror</code> 中封装一些信息，让我们可以获取到调用栈的信息！(在这里感谢<code>github.com/pkg/errors</code>库的贡献者，让我得以踩在巨人的肩膀之上。)</p>
<h2 id="5调用栈信息的获取与封装">5.调用栈信息的获取与封装<a hidden class="anchor" aria-hidden="true" href="#5调用栈信息的获取与封装">#</a></h2>
<p>接下来的步骤我不会像前面一样直接展示代码再进行解释，而是一点点的与你一同构建。</p>
<p>我们首先要思考的是，到底如何获取调用栈？答案是<code>runtime</code>中文名也叫<code>运行时</code>，相信你听这个名字就能明白大致的含义。</p>
<p>这里面有一个函数的定义如下：</p>
<blockquote>
<p>Callers(skip int, pc []uintptr) int</p>
</blockquote>
<p>使用 <strong>runtime.Callers()</strong> ，就可以将栈的信息存储在<strong>pc</strong>中，我们先skip这个skip变量的含义，先说<strong>pc</strong>的类型，<strong>[]uintptr</strong>中的<strong>uintptr</strong>是什么呢？或许你可以看看这篇文章：<a href="https://cloud.tencent.com/developer/article/2414117">深入探究 uintptr 类型</a></p>
<p>现在你可以去试一试这个函数的作用啦，我这里试过了我就继续讲 ^v^</p>
<p>在进行了上述的学习后我想到，要是能包装成一个函数来方便的进行caller的获取就好了，不然每次获取都要定义好麻烦哦，好的这就来了！</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">callers</span>() []<span style="color:#a6e22e">unitptr</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">depth</span> = <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pcs</span> [<span style="color:#a6e22e">depth</span>]<span style="color:#66d9ef">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Callers</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">pcs</span>[:]) <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">st</span> <span style="color:#a6e22e">stack</span> = <span style="color:#a6e22e">pcs</span>[<span style="color:#ae81ff">0</span>:<span style="color:#a6e22e">n</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">st</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>啥？直接用 <strong>[]uintptr</strong> 传递不好看？含义不明？不方便格式化？你说的有道理，那我们再对其进行封装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">stack</span> []<span style="color:#66d9ef">uintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">callers</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">stack</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">depth</span> = <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pcs</span> [<span style="color:#a6e22e">depth</span>]<span style="color:#66d9ef">uintptr</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Callers</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">pcs</span>[:])
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">st</span> <span style="color:#a6e22e">stack</span> = <span style="color:#a6e22e">pcs</span>[<span style="color:#ae81ff">0</span>:<span style="color:#a6e22e">n</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">st</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>嗯，这样看起来好看多啦，那下一步呢？虽然套了层皮，但是那陌生神秘的 <strong>[]uintptr</strong> 该如何转换成我们能看懂的东西呢？简单来说就是怎么格式化为字符串呢？</p>
<h2 id="6调用栈格式化与输出">6.调用栈格式化与输出<a hidden class="anchor" aria-hidden="true" href="#6调用栈格式化与输出">#</a></h2>
<p>接下来还是来请出我们还不甚了解的<code>runtime</code> 如果你学过计算机组成原理应该知道，有一个特殊的寄存器是用来存储指令地址的，而且还会程序的递增而增加，没错，就是<strong>pc(Program Counter)</strong>, 他存储下一条要执行的指令的地址，而每执行一条指令，pc也会加一，从而指向下一条地址。此时我们stack中的一个个的uintptr我将其理解为一个个pc，(有待考究)，那有了pc我们再使用<code>runtime</code> 的函数就可以把我们获取的信息进行格式化。</p>
<p>接下来让我们针对一条<strong>uintptr</strong>来获取 <strong>file</strong>,<strong>line</strong>,和<strong>name</strong>信息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">file</span>(<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uintptr</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">FuncForPC</span>(<span style="color:#a6e22e">u</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">FileLine</span>(<span style="color:#a6e22e">u</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">file</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">line</span>(<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uintptr</span>) <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">FuncForPC</span>(<span style="color:#a6e22e">u</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">FileLine</span>(<span style="color:#a6e22e">u</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">line</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">name</span>(<span style="color:#a6e22e">u</span> <span style="color:#66d9ef">uintptr</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">FuncForPC</span>(<span style="color:#a6e22e">u</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">Name</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>现在，我们就可以从一条<strong>uintptr</strong>里面获取他包含的上述信息了，此时你是不是觉得可以和<code>stack</code> 结合一下准备格式化输出了？对，也不对。此时虽然已经可以了，但是看看上面这么多的函数，优雅吗？不优雅！所以还是让我们使用一个结构体来对其进行包装。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Frame</span> <span style="color:#66d9ef">uintptr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">Frame</span>) <span style="color:#a6e22e">pc</span>() <span style="color:#66d9ef">uintptr</span> { <span style="color:#66d9ef">return</span> uintptr(<span style="color:#a6e22e">f</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> } <span style="color:#75715e">// 为什么要减1呢？ 因为调用了一个函数pc又加一啦！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">Frame</span>) <span style="color:#a6e22e">file</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">FuncForPC</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">pc</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">FileLine</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">pc</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">file</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">Frame</span>) <span style="color:#a6e22e">line</span>() <span style="color:#66d9ef">int</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">FuncForPC</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">pc</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">line</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">FileLine</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">pc</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">line</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">Frame</span>) <span style="color:#a6e22e">name</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">FuncForPC</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">pc</span>())
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fn</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">Name</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>现在看起来是不是优雅多啦？什么？还不够优雅？我也觉得，我们应该把<code>Frame</code> 也实现格式化呀！这样<code>stack</code>才更方便！说干就干</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">f</span> <span style="color:#a6e22e">Frame</span>) <span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">s</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">verb</span> <span style="color:#66d9ef">rune</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">verb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;s&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Flag</span>(<span style="color:#e6db74">&#39;+&#39;</span>):
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">name</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;\n\t&#34;</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">file</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">Base</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">file</span>()))
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;d&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">line</span>()))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;n&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">funcname</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">name</span>()))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;v&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#39;s&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#34;:&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">s</span>, <span style="color:#e6db74">&#39;d&#39;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">funcname</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">LastIndex</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;/&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">name</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">i</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Index</span>(<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">name</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>嗯，现在好多了。针对每一个<strong>uintptr</strong>我们都可以使用 <strong>%+v</strong> 对其进行直接的格式化啦。针对一个<code>stack</code>，多次调用即可。下面是<code>stack</code>的 <strong>Format</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">stack</span>) <span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">st</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">verb</span> <span style="color:#66d9ef">rune</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">verb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;v&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">s</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Frame</span>(<span style="color:#a6e22e">pc</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">st</span>, <span style="color:#e6db74">&#34;\n%+v&#34;</span>, <span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>为了更格式更统一，我们加上一些限制：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">stack</span>) <span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">st</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">verb</span> <span style="color:#66d9ef">rune</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">verb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;v&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">st</span>.<span style="color:#a6e22e">Flag</span>(<span style="color:#e6db74">&#39;+&#39;</span>):
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">pc</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">s</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Frame</span>(<span style="color:#a6e22e">pc</span>)
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">st</span>, <span style="color:#e6db74">&#34;\n%+v&#34;</span>, <span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="7将调用栈集成到自定义错误中">7.将调用栈集成到自定义错误中<a hidden class="anchor" aria-hidden="true" href="#7将调用栈集成到自定义错误中">#</a></h2>
<p>好啦！忙活了这么久，让我们来把<code>stack</code>加入到<code>merror</code>中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">merror</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg</span>   <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">extra</span> <span style="color:#66d9ef">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">stack</span>      <span style="color:#75715e">// 注意这里的格式，这是为了让stack直接参与到merror的格式化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">extra</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">int64</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">merror</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">msg</span>:   <span style="color:#a6e22e">msg</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">stack</span>: <span style="color:#a6e22e">callers</span>(),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">extra</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">extra</span> = <span style="color:#a6e22e">extra</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>来让我们检验一下成果吧！</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">merror</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;a error&#34;</span>, <span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%s\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ex</span> <span style="color:#a6e22e">merror</span>.<span style="color:#a6e22e">Merror</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">As</span>(<span style="color:#a6e22e">e</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ex</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%d\n&#34;</span>, <span style="color:#a6e22e">ex</span>.<span style="color:#a6e22e">Extra</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;%+v\n&#34;</span>, <span style="color:#a6e22e">ex</span>)		 <span style="color:#75715e">// 注意改成了+v
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输出结果：</p>
<blockquote>
<p>a error<br>
1024<br>
msg: a error,extra: 1024</p>
</blockquote>
<p>什么鬼？怎么什么变化都没有的？相信你此刻会有点懵逼，不要着急，是不是忘记了占位符格式化的依据是<strong>Format</strong>方法，而我们此时占位符上的变量可是<code>merror.Merror</code> 而不是<code>stack</code>哦，再来写上几行吧。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">merror</span>) <span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">state</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">State</span>, <span style="color:#a6e22e">verb</span> <span style="color:#66d9ef">rune</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">verb</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#39;s&#39;</span>, <span style="color:#e6db74">&#39;v&#39;</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;msg: %s,extra: %d&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">msg</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">extra</span>))
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">switch</span> {
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">Flag</span>(<span style="color:#e6db74">&#39;+&#39;</span>):
</span></span><span style="display:flex;"><span>             	<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%+v&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">stack</span>)) <span style="color:#75715e">// here！
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>a error  
</span></span><span style="display:flex;"><span>1024  
</span></span><span style="display:flex;"><span>msg: a error,extra: 1024  
</span></span><span style="display:flex;"><span>runtime.Callers  
</span></span><span style="display:flex;"><span>        /usr/local/go/src/runtime/extern.go:331  
</span></span><span style="display:flex;"><span>mutezebra/pkg/merror.callers  
</span></span><span style="display:flex;"><span>        /projects/mutezebra/pkg/merror/stack.go:82  
</span></span><span style="display:flex;"><span>mutezebra/pkg/merror.New  
</span></span><span style="display:flex;"><span>        /projects/mutezebra/pkg/merror/merror.go:22  
</span></span><span style="display:flex;"><span>main.main  
</span></span><span style="display:flex;"><span>        /projects/mutezebra/main.go:10  
</span></span><span style="display:flex;"><span>runtime.main  
</span></span><span style="display:flex;"><span>        /usr/local/go/src/runtime/proc.go:272  
</span></span><span style="display:flex;"><span>runtime.goexit  
</span></span><span style="display:flex;"><span>        /usr/local/go/src/runtime/asm_amd64.s:1700 
</span></span></code></pre></div><p>看到这里是不是觉得大功告成了？是的，我想说的就这些啦。</p>
<h2 id="8结尾">8.结尾<a hidden class="anchor" aria-hidden="true" href="#8结尾">#</a></h2>
<p>彩蛋：还记不记得我们前面有一个skip掉的<code>runtime.Caller()</code>的skip变量，去试试怎么回事吧！</p>
<p>源代码文件：<a href="https://github.com/mutezebra/blogResource-external/tree/main/codes/merror">merror</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/go/">Go</a></li>
      <li><a href="http://localhost:1313/tags/error/">Error</a></li>
      <li><a href="http://localhost:1313/tags/log/">Log</a></li>
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">mutezebra</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://utteranc.es/client.js"
repo="mutezebra/mutezebra.github.io"
issue-term="title"
theme="github-dark"
crossorigin="anonymous"
async>
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
